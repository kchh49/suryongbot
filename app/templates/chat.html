<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>입시도우미 수룡이</title>
    <link rel="stylesheet" href="/static/assets/style_chat.css" />
  </head>
  <body class="chat-body-bg">
    <!-- 상단 바 -->
    <div class="chat-header">
      <div class="logo-group">
        <img src="/static/assets/logo.png" alt="성신여대 로고" class="logo-img" />
      </div>
      <div class="header-buttons">
        <div class="dot green"></div>
        <div class="dot yellow"></div>
        <div class="dot red"></div>
        <div class="header-icon"></div>
        <div class="header-menu"></div>
      </div>
    </div>

    <!-- 채팅 내용 -->
    <div class="chat-container" id="chatBody">
      <!-- 채팅 말풍선은 JS로 추가됨 -->
    </div>

    <!-- 입력창 -->
    <div class="input-area">
      <textarea id="questionInput" placeholder="수룡이에게 궁금한 것을 물어봐!"></textarea>
      <button onclick="sendMessage()" class="send-btn">&#x2191;</button>
    </div>

    <div class="recommend-questions" id="recommendQuestions"> //추천질문박스
    </div>

    <script>
      async function sendMessage() {
        const input = document.getElementById("questionInput");
        const text = input.value.trim();
        if (!text) return;
    
        const chatBody = document.getElementById("chatBody");
    
        // ① 사용자 말풍선
        const userBubble = document.createElement("div");
        userBubble.className = "chat-bubble user";
        userBubble.textContent = text;
        chatBody.appendChild(userBubble);
        input.value = "";
        chatBody.scrollTop = chatBody.scrollHeight;
    
        // ② "입력중입니다..." 수룡이 말풍선
        const botContainer = document.createElement("div");
        botContainer.className = "bot-container";
    
        const suryongImg = document.createElement("img");
        suryongImg.src = "/static/assets/suryong.png";
        suryongImg.alt = "수룡이";
        suryongImg.className = "suryong-profile";
    
        const botBubble = document.createElement("div");
        botBubble.className = "chat-bubble bot";
        botBubble.textContent = "입력중입니다..."; // 초기 로딩 메시지
    
        botContainer.appendChild(suryongImg);
        botContainer.appendChild(botBubble);
        chatBody.appendChild(botContainer);
        chatBody.scrollTop = chatBody.scrollHeight;
    
        try {
          const res = await fetch("/query", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ query: text })
          });
    
          const data = await res.json();
    
          // ③ GPT 응답으로 메시지 업데이트
          botBubble.textContent = data.answer || "답변을 가져오는 데 문제가 생겼어요.";
          chatBody.scrollTop = chatBody.scrollHeight;
    
        } catch (error) {
          botBubble.textContent = "⚠️ 서버와 연결할 수 없어요.";
          chatBody.scrollTop = chatBody.scrollHeight;
        }
      }
      const textarea = document.getElementById('questionInput');

let typingTimer;  // 여기부터 추천검색어
const typingDelay = 2000;  // 2초후에 추천질문 불러오기기
const input = document.getElementById("questionInput");

input.addEventListener("input", () => {
  clearTimeout(typingTimer); //타이핑 중에는 추천을 띄우지 않게 함
  if (input.value.trim()) { //공백을 제거한 사용자의 현재 입력값이 있는지 확인
    typingTimer = setTimeout(fetchSuggestions, typingDelay); 
  }
});

async function fetchSuggestions() {
  const text = input.value.trim();
  if (!text) return;

  try {
    const res = await fetch("/suggest", {
      method: "POST", //백엔드에 POST 요청 보내서 추천 질문 요청함.
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ query: text }) //사용자 입력값을 QUERY로 백엔드에 전달
    });

    const data = await res.json();
    updateSuggestedTags(data.results); //질문 리스트 화면에 표시하기 위해 여기로 넘겨준다
  } catch (e) {
    console.warn("추천 질문 불러오기 실패", e);
  }
}

function updateSuggestedTags(questions) { //추천질문배열해주는 함수
  const container = document.getElementById("recommendQuestions");
  container.innerHTML = "";
  questions.forEach(q => {
    const tag = document.createElement("div");
    tag.className = "recommend-question-tag";
    tag.textContent = `#${q}`; //태그+질문 형태로 나옴
    tag.onclick = () => { //태그 클릭
      input.value = q; //클릭된 질문으로 입력창 채워넣음
      input.focus();
      sendMessage(); //클릭 시 GPT에 질문 전송
    };
    container.appendChild(tag); //만들어진 추천 태그들을 화면에 하나씩 추가함
  });
}

    </script> 
    
  </body>
</html>
